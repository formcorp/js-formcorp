var GREENID={USER_ID:"result.return.verificationResult.userId",STATE:{PENDING:"pending",VERIFIED:"verified",REJECTED:"rejected"}},fcGreenID=function(a){"use strict";if(!fc)return{};var b={address:"greenIDAddress",country:"greenIDCountry",dob:"greenIDDOB",email:"greenIDEmail",firstName:"greenIDFirstName",integrationId:"greenIDIntegration",middleName:"greenIDMiddleName",postcode:"greenIDPostcode",state:"greenIDState",suburb:"greenIDSuburb",title:"greenIDTitle",surname:"greenIDSurname"},c=function(a,c){var d,e={},f=function(a){if(c.indexOf(fc.constants.prefixSeparator)>=0){var b=c.split(fc.constants.prefixSeparator)[0],d=fc.fieldSchema[b],e=d.config.sourceField,f=c.split(fc.constants.prefixSeparator);f.length>2&&(e+="."+f[1]+"."),e+=a;var g=e.split(".").reduce(function(a,b){return"undefined"!=typeof a?a[b]:void 0},fc.fields);if("undefined"!=typeof g)return g}return fc.getValue(a)};for(var g in b)b.hasOwnProperty(g)&&(d=fc.getConfig(a,b[g],""),d.length>0&&(e[g]=f(d)));return e},d=function(a){return""+a.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)},e=function(a){return a.passed===!0||["VERIFIED","VERIFIED_ADMIN","VERIFIED_WITH_CHANGES","PASSED","PENDING"].indexOf(a.state)>=0},f=function(a,b){for(var c,d=/<%([^%>]+)?%>/g,e=/(^( )?(if|for|else|switch|case|break|{|}))(.*)?/g,f="var r=[];\n",g=0,h=function(a,b){return f+=b?a.match(e)?a+"\n":"r.push("+a+");\n":""!=a?'r.push("'+a.replace(/"/g,'\\"')+'");\n':"",h};c=d.exec(a);)h(a.slice(g,c.index))(c[1],!0),g=c.index+c[0].length;return h(a.substr(g,a.length-g)),f+='return r.join("");',new Function(f.replace(/[\r\t\n]/g,"")).apply(b)};return{init:function(){fc.loadMaterialDatepicker(),console.log("greenid: init")},initGreenId:function(){console.log("greenid: initGreenId")},passesValidation:function(){return console.log("greenid: passesValidation"),!1},session:function(b){var g=fc.getFieldDefinition(b),h=c(g,b),i=d(JSON.stringify(h));if("undefined"!=typeof fcGreenID.sessions[i])return fcGreenID.sessions[i];var j=this;this.fieldIds=[b],this.events=function(){var a={},b=a.hasOwnProperty;return{const:{DISPLAY_CHILD_SOURCE:"greenid/options/display-child",DISPLAY_SOURCE:"greenid/options/display-source",DISPLAY_SUCCESS:"greenid/messages/success",EXTRA_FAILED:"greenid/extra/fail",FATAL_ERROR:"greenid/errors/fatal",FETCH_RESULT_INITIALISED:"greenid/fetch/initialised",FETCH_RESULT_NOT_INITIALISED:"greenid/fetch/not-initialised",GET_EXTRA_DATA:"greenid/extra/get",OPTION_CLICKED:"greenid/options/clicked",READY_FOR_RENDER:"greenid/render/ready",RENDER_PENDING:"greenid/render/main",RENDER_VERIFIED:"greenid/render/verified",SHOW_EXTRA_DATA_SOURCE:"greenid/extra/show",SOURCE_SUBMIT:"greenid/source/submit",SOURCE_VERIFIED:"greenid/source/verified",VERIFICATION_DO:"greenid/verification/do",VERIFICATION_ERROR:"greenid/verification/error",VERIFICATION_SUCCESS:"greenid/verification/success"},subscribe:function(c,d){b.call(a,c)||(a[c]=[]);var e=a[c].push(d)-1;return{remove:function(){delete a[c][e]}}},publish:function(c,d){b.call(a,c)&&a[c].forEach(function(a){a(void 0!=d?d:{})})}}}(),this.fieldId=b,this.field=fc.getFieldDefinition(b),this.config=this.field.config,this.options=this.config.greenIDIntegration.config,this.extraData={},this.userId=function(){var a=fc.getValue(j.fieldId);return"object"==typeof a&&"object"==typeof a.result?a.result.return.verificationResult.userId:null},this.events.subscribe(this.events.const.FETCH_RESULT_INITIALISED,function(a){var b=fc.getValue(j.fieldId);"object"==typeof b&&("object"==typeof a&&"object"==typeof a.result&&fc.setVirtualValue(j.fieldId,a.result),j.events.publish(j.events.const.READY_FOR_RENDER))}),this.events.subscribe(this.events.const.FETCH_RESULT_NOT_INITIALISED,function(a){var b=c(j.field,j.fieldId);b.fieldId=j.fieldId,Object.keys(j.extraData).length>0&&(b.extra=j.extraData),fc.api("greenid/gateway-v2/init",b,"POST",function(a){if(fc.setVirtualValue(j.fieldId,{values:b,result:a}),Object.keys(j.extraData).length>0){var c=_.find(j.options.sources.extraData,function(a){return a.key==j.extraData.source});if("undefined"==typeof c||!_.isObject(c.onFail))return void j.events.publish(j.events.const.READY_FOR_RENDER);var d=_.find(a.return.verificationResult.individualResults,function(a){return a.name==c.source});if("undefined"==typeof d)return void j.events.publish(j.events.const.READY_FOR_RENDER);if(!e(d))return void j.events.publish(j.events.const.EXTRA_FAILED,c);j.events.publish(j.events.const.READY_FOR_RENDER)}else j.events.publish(j.events.const.READY_FOR_RENDER)})}),this.events.subscribe(this.events.const.EXTRA_FAILED,function(a){var b=f('<div class="fc-green-id extra-data-source"> <div class="options">   <div class="child-container with-submit">     <div class="pre-verification">       <h4><%this.title%></h4>       <div class="desc"><%this.desc%></div>     </div>   </div>   <div class="status-bar"></div>   <div class="source-submit">     <div class="links">       <a href="#"data-for="<%this.source%>" data-continue="true" class="btn"><%this.text%></a>     </div>   </div> </div></div>',{title:fc.tokenise(a.onFail.label),desc:fc.tokenise(a.onFail.msg||""),text:"Continue"});j.render(b)}),this.events.subscribe(this.events.const.READY_FOR_RENDER,function(a){var b=j.getApplicationStatus();switch(b){case GREENID.STATE.VERIFIED:j.events.publish(j.events.const.RENDER_VERIFIED,a);break;case GREENID.STATE.REJECTED:j.events.publish(j.events.const.FATAL_ERROR,{msg:"We're sorry, but we could not verify your identity."});break;case GREENID.STATE.PENDING:j.events.publish(j.events.const.RENDER_PENDING,a)}}),this.events.subscribe(this.events.const.RENDER_PENDING,function(a){var b=_.filter(j.options.sources.active,function(a){return a.primary===!0}),c="";_.each(b,function(a){var b=a.source;("string"!=typeof a.source||j.userHasSource(b))&&(c+=f('<li class="fc-greenid-source" data-status="<%this.status%>" data-source="'+a.key+'"> <div class="icon"><div></div></div> <label>'+a.label+"</label></li>",{status:j.getSourceStatus(a)}))});var d=f('<div class="fc-green-id fc-ready"> <div class="options primary">   <ul>'+c+'</ul>   <div class="fc-clear"></div> </div> <%this.error%></div>',{error:"string"==typeof a.error?'  <div class="verification-error">'+a.error+"</div>":""});j.render(d)}),this.events.subscribe(this.events.const.RENDER_VERIFIED,function(a){var b=_.filter(j.options.sources.active,function(a){return a.primary===!0}),c="";_.each(b,function(a){var b=j.getSourceStatus(a);if("verified"===b){a.source;c+=f('<li class="fc-greenid-source" data-status="<%this.status%>" data-source="'+a.key+'"> <div class="icon"><div></div></div> <label>'+a.label+"</label></li>",{status:b})}});var d=f('<div class="fc-green-id fc-ready"> <div class="options primary">   <ul>'+c+'</ul>   <div class="fc-clear"></div> </div> <div class="status-bar"></div></div>');j.render(d),j.events.publish(j.events.const.VERIFICATION_SUCCESS,{msg:"Your identify has successfully been verified."})}),this.events.subscribe(this.events.const.FATAL_ERROR,function(a){var b=f('<div class="fc-green-id fatal-error"> <div><%this.msg%></div></div>',{msg:a.msg});j.render(b)}),this.events.subscribe(this.events.const.OPTION_CLICKED,function(a){var b=_.find(j.options.sources.active,function(b){return b.key==a.source});return b.source===!1?void j.events.publish(j.events.const.DISPLAY_CHILD_SOURCE,b):void j.events.publish(j.events.const.DISPLAY_SOURCE,b)}),this.events.subscribe(this.events.const.DISPLAY_SOURCE,function(a){j.render(j.loading("Retrieving source details"));var b={fieldId:j.fieldId,sourceId:a.source,verificationUserId:j.userId()},c=a;fc.api("greenid/gateway-v2/get-fields",b,"POST",function(a){var b=a.return.sourceFields.rawData,d=b.replace(/<[\/]{0,1}sourcefields>/g,"",b);d=d.replace(/<\?xml[^\/]+\?>/g,"",d);var e=f('<div class="fc-green-id"> <div class="options">   <div class="child-container with-submit">     <div class="close"></div>     <div class="source">       <h3>'+c.label+'</h3>       <div class="fields">'+d+'</div>     </div>   </div>   <div class="source-submit">     <div class="submit" data-source="'+c.key+'"><%this.lang.submit%></div>     <div class="verifying">       <div class="container fc-green-init-css">         <span class="spinner"></span>         <span><%this.lang.verifying%></span>       </div>     </div>   </div>   <div class="status-bar"></div> </div></div>',{lang:{submit:"Verify",verifying:"Verifying"}});j.render(e)})}),this.events.subscribe(this.events.const.DISPLAY_CHILD_SOURCE,function(a){var b=_.filter(j.options.sources.active,function(b){return b.belongsTo===a.key}),c="";_.each(b,function(a){("string"!=typeof a.source||j.userHasSource(a.source)&&!j.sourceIsLocked(a))&&(c+=f('<li class="fc-child-source" data-source="'+a.key+'" data-status="<%this.status%>"> <label>'+a.label+"</label></li>",{status:j.getSourceStatus(a)}))});var d=f('<div class="fc-green-id">  <div class="child-sources options secondary">   <div class="child-container">     <div class="close"></div>     <div class="header">       <h3>'+a.label+"</h3>       <h5>"+a.desc+'</h5>     </div>     <div class="child-options">       <ul>'+c+'</ul>       <div class="fc-clear"></div>     </div>    </div>  </div></div>');j.render(d)}),this.events.subscribe(this.events.const.SOURCE_SUBMIT,function(b){var c=b.dom,d=c.find(".required"),e=0;d.length>0&&d.each(function(){var b=a(this),c=b.parent(),d=fc.getFieldValue(b);b.is('input[type="checkbox"]')&&b.is(":checked")&&(d="on"),_.isString(d)&&0!==d.length?c.removeClass("fc-error"):(c.addClass("fc-error"),++e)}),e?j.events.publish(j.events.const.VERIFICATION_ERROR,{error:"Please ensure all required form fields are correctly filled out prior to verification."}):(j.events.publish(j.events.const.VERIFICATION_NO_ERROR),j.events.publish(j.events.const.VERIFICATION_DO,b))}),this.events.subscribe(this.events.const.VERIFICATION_ERROR,function(a){var b=j.getDomElements(),c=b.find(".status-bar"),d=f('<div class="error"> <span><%this.text.error%></div>',{text:{error:a.error}});c.html(d)}),this.events.subscribe(this.events.const.VERIFICATION_SUCCESS,function(a){var b=j.getDomElements(),c=b.find(".status-bar"),d=f('<div class="success"> <span><%this.text.message%></div>',{text:{message:a.msg}});c.html(d)}),this.events.subscribe(this.events.const.VERIFICATION_NO_ERROR,function(a){var b=j.getDomElements(),c=b.find(".status-bar");c.html("")}),this.events.subscribe(this.events.const.VERIFICATION_DO,function(b){var c=b.dom,d=c.find(".source-submit"),f={};d.addClass("verifying"),c.find("input,select").each(function(){var b=a(this),c=b.attr("name"),d=fc.getFieldValue(b);b.is('input[type="checkbox"]')&&b.is(":checked")&&(d="on"),"undefined"==typeof d&&(d=""),"string"==typeof c&&c.length>0&&(f[c]=d)});var g={fieldId:j.fieldId,verificationUserId:j.userId(),data:f};fc.api("greenid/gateway-v2/verify?source="+b.source,g,"POST",function(a){if(a.success===!1&&"string"==typeof a.message&&a.message.length>0)return a.message.indexOf("locked out of")>=0?void j.updateRemotely(function(a){switch(d.removeClass("verifying"),j.getApplicationStatus()){case GREENID.STATE.REJECTED:return void j.events.publish(j.events.const.FATAL_ERROR,{msg:"We're sorry, but we could not verify your identity."})}j.events.publish(j.events.const.RENDER_PENDING,{error:"You've been locked out of the selected data source due to too many failed attempts. Please select a different method."})}):(d.removeClass("verifying"),void j.events.publish(j.events.const.VERIFICATION_ERROR,{error:a.message}));if(a.success===!0){var c=a.response.return.checkResult;return void(e(c)?j.events.publish(j.events.const.SOURCE_VERIFIED,b):(d.removeClass("verifying"),j.events.publish(j.events.const.VERIFICATION_ERROR,{error:"We're sorry, but electronic identification failed, please try again"})))}d.removeClass("verifying"),j.events.publish(j.events.const.VERIFICATION_ERROR,{error:"An unexpected error occurred when verifying the data source."})})}),this.events.subscribe(this.events.const.SOURCE_VERIFIED,function(a){fc.api("greenid/gateway-v2/fetch",{fieldId:j.fieldId},"POST",function(a){"object"==typeof a.data&&(a.data.initialised&&fc.setVirtualValue(j.fieldId,a.data.result),j.getApplicationStatus()===GREENID.STATE.VERIFIED?j.events.publish(j.events.const.DISPLAY_SUCCESS,{msg:"Your identity has successfully been verified."}):j.init(!1))})}),this.events.subscribe(this.events.const.DISPLAY_SUCCESS,function(a){var b=f('<div class="fc-green-id large-success"> <div class="close"></div> <div><%this.msg%></div></div>',{msg:a.msg});j.render(b)}),this.events.subscribe(this.events.const.GET_EXTRA_DATA,function(a){var b=j.options.sources.extraData[0];j.events.publish(j.events.const.SHOW_EXTRA_DATA_SOURCE,b)}),this.events.subscribe(this.events.const.SHOW_EXTRA_DATA_SOURCE,function(a){var b="";_.each(a.preAgree.buttons,function(c){b+=f('<a href="#" data-method="<%this.method%>" data-for="<%this.source%>" class="btn"><%this.text%></a>',{method:c.method,text:c.text,source:a.key})});var c=f('<div class="fc-green-id extra-data-source"> <div class="options">   <div class="child-container with-submit">     <div class="pre-verification">       <h4><%this.title%></h4>       <div class="desc"><%this.desc%></div>     </div>   </div>   <div class="status-bar"></div>   <div class="source-submit">     <div class="links"><%this.buttons%></div>   </div> </div></div>',{title:fc.tokenise(a.preAgree.label),desc:fc.tokenise(a.preAgree.msg||""),buttons:b,source:a.key});j.render(c)}),this.updateRemotely=function(a,b){"boolean"!=typeof b&&(b=!0),fc.api("greenid/gateway-v2/fetch",{fieldId:j.fieldId},"POST",function(c){"object"==typeof c.data&&(b&&c.data.initialised&&fc.setVirtualValue(j.fieldId,c.data.result),"function"==typeof a?a(c.data):"string"==typeof a&&j.events.publish(event,c.data))})},this.getUserVerificationSources=function(){for(var a,b=fc.getValue(j.fieldId),c=b.result.return.sourceList.sources,d={},e=0,f=c.length;e<f;e++)a=c[e],d[a.name]=a;return d},this.getSourceStatus=function(a){var b="available";return j.sourceIsVerified(a)?b="verified":j.sourceIsLocked(a)&&(b="locked-out"),b},this.getApplicationStatus=function(){var a=fc.getValue(j.fieldId),b=a.result.return.verificationResult.outcome;GREENID.STATE.PENDING;switch(b){case"VERIFIED":case"VERIFIED_ADMIN":case"VERIFIED_WITH_CHANGES":case"PENDING":return GREENID.STATE.VERIFIED;case"LOCKED_OUT":return GREENID.STATE.REJECTED;case"IN_PROGRESS":default:return GREENID.STATE.PENDING}},this.userHasSource=function(a){var b=j.getUserVerificationSources();return b.hasOwnProperty(a)},this.sourceIsVerified=function(a){var b=j.getUserVerificationSources();if(a.source===!1){var c=_.find(j.options.sources.active,function(c){return"string"==typeof c.source&&c.belongsTo===a.key&&j.userHasSource(c.source)&&e(b[c.source])});return"object"==typeof c}return j.userHasSource(a.source)&&e(b[a.source])},this.sourceIsLocked=function(a){var b=j.getUserVerificationSources();if(!j.userHasSource(a.source))return!1;var c=b[a.source];return"LOCKED_OUT"===c.state},this.hasExtraData=function(){return _.isObject(this.options)&&_.isObject(this.options.sources)&&_.isArray(this.options.sources.extraData)&&this.options.sources.extraData.length>0},this.loading=function(a){return f('<div class="fc-green-id initialising"> <div class="init">   <div class="fc-green-init-css">     <div></div>   </div>   <%this.text.init%> </div></div>',{text:{init:a}})},this.begin=function(){return j.loading("Starting up identity verification")},this.configureEventListeners=function(){var b=j.getDomElements();b.on("click",".options li",function(){var b=a(this),c=b.attr("data-source"),d=b.attr("data-status");"available"===d&&j.events.publish(j.events.const.OPTION_CLICKED,{source:c})}),b.on("click",".fc-green-id .close",function(){return j.events.publish(j.events.const.READY_FOR_RENDER),!1}),b.on("click",".fc-green-id .source-submit .submit",function(){var b=a(this),c=b.attr("data-source"),d=_.find(j.options.sources.active,function(a){return a.key==c});d.dom=b.parent().parent(),j.events.publish(j.events.const.SOURCE_SUBMIT,d)}),b.on("click",".fc-green-id.extra-data-source .source-submit .links a",function(){var b=a(this),c=b.attr("data-method"),d=b.attr("data-for"),e=b.attr("data-continue");if(_.isString(e)&&"true"===e)return void j.events.publish(j.events.const.READY_FOR_RENDER);var f=_.find(j.options.sources.extraData,function(a){return a.key==d});if("undefined"==typeof f)return!1;var g=_.find(f.preAgree.buttons,function(a){return a.method==c});return"undefined"!=typeof g&&(j.extraData=_.isObject(g.extra)?g.extra:{},Object.keys(j.extraData).length>0&&(j.extraData.source=d),j.render(j.loading("Initialising...")),j.events.publish(j.events.const.FETCH_RESULT_NOT_INITIALISED,b.data),!1)}),j.setupEventListeners=!0},this.init=function(a,b){if("undefined"!=typeof _)return"boolean"==typeof j.setupEventListeners&&j.setupEventListeners||j.configureEventListeners(),"string"==typeof b&&fcGreenID.initialised.indexOf(b)<0&&fcGreenID.initialised.push(b),"boolean"!=typeof a&&(a=!0),a?void fc.api("greenid/gateway-v2/fetch",{fieldId:this.fieldId},"POST",function(a){"object"==typeof a.data&&"boolean"==typeof a.data.initialised&&(a.data.initialised?j.events.publish(j.events.const.FETCH_RESULT_INITIALISED,a.data):j.hasExtraData()?j.events.publish(j.events.const.GET_EXTRA_DATA,a.data):j.events.publish(j.events.const.FETCH_RESULT_NOT_INITIALISED,a.data))}):void j.events.publish(j.events.const.FETCH_RESULT_INITIALISED,{})},this.getDomElements=function(){for(var a=[],b=0,c=j.fieldIds.length;b<c;b++)a.push('[fc-data-group="'+j.fieldIds[b]+'"]');return fc.domContainer.find(a.join(","))},this.render=function(a){var b=j.getDomElements();if(0!==b.length){b.hasClass("fc-error")&&b.removeClass("fc-error");var c=f('<div class="fc-fieldgroup"> <div class="fc-field-element-contrainer">   <%this.html%>   <div class="fc-success-box"><span></span></div>   <div class="fc-error-box"><span></span></div> </div> <div class="fc-error-text"></div> <div class="fc-empty"></div></div>',{html:a});b.html(c)}},fcGreenID.sessions[i]=this},initialised:[],fieldIds:[],getSession:function(a){var b=fc.getFieldDefinition(a),e=c(b,a),f=d(JSON.stringify(e)),g=fcGreenID.sessions[f];return g.fieldIds.indexOf(a)<0&&g.fieldIds.push(a),g},sessions:{},template:f}}(jQuery);!function(a){"use strict";a(fc.jQueryContainer).trigger(fc.jsEvents.onGreenIdLoaded),fc.domContainer.on(fc.jsEvents.onVisibilityChanged,function(){fc.initGreenIdDOMFields()})}(jQuery);